{
    "sourceFile": "notify/signals.py",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 6,
            "patches": [
                {
                    "date": 1739869421688,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1739869432853,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,8 +2,9 @@\n from django.dispatch import receiver\n from django.contrib.auth import get_user_model\n from .models import Notification\n from .utils import create_notification\n+from accounts.\n \n User = get_user_model()\n \n @receiver(post_save, sender=User)\n"
                },
                {
                    "date": 1739869440588,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -2,10 +2,11 @@\n from django.dispatch import receiver\n from django.contrib.auth import get_user_model\n from .models import Notification\n from .utils import create_notification\n-from accounts.\n+from accounts.models import CustomUser as User\n \n+\n User = get_user_model()\n \n @receiver(post_save, sender=User)\n def notify_on_user_update(sender, instance, created, **kwargs):\n"
                },
                {
                    "date": 1739870065219,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,36 +1,85 @@\n from django.db.models.signals import post_save, post_delete\n from django.dispatch import receiver\n-from django.contrib.auth import get_user_model\n+from django.contrib.auth.models import Permission\n+from django.apps import apps\n+from django.contrib.contenttypes.models import ContentType\n+from django.utils.timezone import now\n+from accounts.models import CustomUser\n from .models import Notification\n-from .utils import create_notification\n-from accounts.models import CustomUser as User\n \n \n-User = get_user_model()\n-\n-@receiver(post_save, sender=User)\n-def notify_on_user_update(sender, instance, created, **kwargs):\n+def notify_users(action, instance, user, model_name):\n     \"\"\"\n-    Notify users when they register or update their account.\n+    Helper function to create notifications for users based on the action type.\n+    - Only notifies users who have specific permissions on the model.\n+    - Includes user details for better tracking.\n     \"\"\"\n-    action = \"created\" if created else \"updated\"\n-    create_notification(\n-        instance,\n-        action,\n-        sender.__name__.lower(),\n-        instance.id,\n-        f\"Your account has been {action}.\"\n+    identifier = getattr(instance, 'slug', instance.id)  # Use slug if available, else id\n+\n+    # Define action messages\n+    action_messages = {\n+        'created': f\"{user.get_full_name()} added a new {model_name} item.\",\n+        'updated': f\"{user.get_full_name()} updated a {model_name} item.\",\n+        'deleted': f\"{user.get_full_name()} deleted a {model_name} item.\",\n+    }\n+\n+    # Notification title and message\n+    title = f\"{model_name.capitalize()} {action.capitalize()}\"\n+    message = action_messages[action]\n+\n+    # Fetch model permissions dynamically\n+    content_type = ContentType.objects.get_for_model(instance.__class__)\n+    permission_codename = f'view_{model_name.lower()}'\n+    view_permission = Permission.objects.filter(content_type=content_type, codename=permission_codename)\n+\n+    # Find users with view permission\n+    users_with_permission = CustomUser.objects.filter(user_permissions__in=view_permission).distinct()\n+\n+    # Create the notification\n+    notification = Notification.objects.create(\n+        title=title,\n+        message=message,\n+        module_name=instance._meta.app_label,\n+        updated_id=str(identifier),\n+        timestamp=now(),\n     )\n+    notification.users.set(users_with_permission)\n+    notification.save()\n \n-@receiver(post_delete, sender=User)\n-def notify_on_user_delete(sender, instance, **kwargs):\n+\n+@receiver(post_save)\n+def create_or_update_notification(sender, instance, created, **kwargs):\n     \"\"\"\n-    Notify users when their account is deleted.\n+    Signal handler for create and update events.\n+    - Automatically detects the model without needing a manual mapping.\n+    - Ensures only relevant users receive notifications.\n     \"\"\"\n-    create_notification(\n-        instance,\n-        \"deleted\",\n-        sender.__name__.lower(),\n-        instance.id,\n-        \"Your account has been deleted.\"\n-    )\n+    if not hasattr(instance, '_meta'):\n+        return  # Skip if instance doesn't have metadata (rare case)\n+\n+    model_name = instance._meta.model_name\n+    user = getattr(instance, 'updated_by', None)  # Assuming a field `updated_by` exists\n+\n+    if not user or not isinstance(user, CustomUser):\n+        return  # Skip if no user associated with the action\n+\n+    action = 'created' if created else 'updated'\n+    notify_users(action, instance, user, model_name)\n+\n+\n+@receiver(post_delete)\n+def delete_notification(sender, instance, **kwargs):\n+    \"\"\"\n+    Signal handler for delete events.\n+    - Ensures only users with permission get notified.\n+    \"\"\"\n+    if not hasattr(instance, '_meta'):\n+        return  # Skip if instance doesn't have metadata\n+\n+    model_name = instance._meta.model_name\n+    user = getattr(instance, 'deleted_by', None)  # Assuming a field `deleted_by` exists\n+\n+    if not user or not isinstance(user, CustomUser):\n+        return  # Skip if no user is associated with the action\n+\n+    notify_users('deleted', instance, user, model_name)\n"
                },
                {
                    "date": 1739870566149,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,71 +1,28 @@\n from django.db.models.signals import post_save, post_delete\n from django.dispatch import receiver\n-from django.contrib.auth.models import Permission\n from django.apps import apps\n-from django.contrib.contenttypes.models import ContentType\n-from django.utils.timezone import now\n from accounts.models import CustomUser\n-from .models import Notification\n+from .utils import notify_user\n \n-\n-def notify_users(action, instance, user, model_name):\n-    \"\"\"\n-    Helper function to create notifications for users based on the action type.\n-    - Only notifies users who have specific permissions on the model.\n-    - Includes user details for better tracking.\n-    \"\"\"\n-    identifier = getattr(instance, 'slug', instance.id)  # Use slug if available, else id\n-\n-    # Define action messages\n-    action_messages = {\n-        'created': f\"{user.get_full_name()} added a new {model_name} item.\",\n-        'updated': f\"{user.get_full_name()} updated a {model_name} item.\",\n-        'deleted': f\"{user.get_full_name()} deleted a {model_name} item.\",\n-    }\n-\n-    # Notification title and message\n-    title = f\"{model_name.capitalize()} {action.capitalize()}\"\n-    message = action_messages[action]\n-\n-    # Fetch model permissions dynamically\n-    content_type = ContentType.objects.get_for_model(instance.__class__)\n-    permission_codename = f'view_{model_name.lower()}'\n-    view_permission = Permission.objects.filter(content_type=content_type, codename=permission_codename)\n-\n-    # Find users with view permission\n-    users_with_permission = CustomUser.objects.filter(user_permissions__in=view_permission).distinct()\n-\n-    # Create the notification\n-    notification = Notification.objects.create(\n-        title=title,\n-        message=message,\n-        module_name=instance._meta.app_label,\n-        updated_id=str(identifier),\n-        timestamp=now(),\n-    )\n-    notification.users.set(users_with_permission)\n-    notification.save()\n-\n-\n @receiver(post_save)\n def create_or_update_notification(sender, instance, created, **kwargs):\n     \"\"\"\n     Signal handler for create and update events.\n-    - Automatically detects the model without needing a manual mapping.\n-    - Ensures only relevant users receive notifications.\n+    - Detects the model dynamically.\n+    - Ensures only the user performing the action gets notified.\n     \"\"\"\n     if not hasattr(instance, '_meta'):\n-        return  # Skip if instance doesn't have metadata (rare case)\n+        return  # Prevent recursion errors\n \n     model_name = instance._meta.model_name\n-    user = getattr(instance, 'updated_by', None)  # Assuming a field `updated_by` exists\n+    user = getattr(instance, 'updated_by', None)  # Assuming an `updated_by` field exists\n \n     if not user or not isinstance(user, CustomUser):\n-        return  # Skip if no user associated with the action\n+        return  # Skip if no user is associated with the action\n \n     action = 'created' if created else 'updated'\n-    notify_users(action, instance, user, model_name)\n+    notify_user(action, instance, user)\n \n \n @receiver(post_delete)\n def delete_notification(sender, instance, **kwargs):\n@@ -73,13 +30,13 @@\n     Signal handler for delete events.\n     - Ensures only users with permission get notified.\n     \"\"\"\n     if not hasattr(instance, '_meta'):\n-        return  # Skip if instance doesn't have metadata\n+        return  # Prevent recursion errors\n \n     model_name = instance._meta.model_name\n-    user = getattr(instance, 'deleted_by', None)  # Assuming a field `deleted_by` exists\n+    user = getattr(instance, 'deleted_by', None)  # Assuming a `deleted_by` field exists\n \n     if not user or not isinstance(user, CustomUser):\n         return  # Skip if no user is associated with the action\n \n-    notify_users('deleted', instance, user, model_name)\n+    notify_user('deleted', instance, user)\n"
                },
                {
                    "date": 1739871180592,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,6 @@\n from django.db.models.signals import post_save, post_delete\n from django.dispatch import receiver\n-from django.apps import apps\n-from accounts.models import CustomUser\n from .utils import notify_user\n \n @receiver(post_save)\n def create_or_update_notification(sender, instance, created, **kwargs):\n@@ -13,16 +11,10 @@\n     \"\"\"\n     if not hasattr(instance, '_meta'):\n         return  # Prevent recursion errors\n \n-    model_name = instance._meta.model_name\n-    user = getattr(instance, 'updated_by', None)  # Assuming an `updated_by` field exists\n-\n-    if not user or not isinstance(user, CustomUser):\n-        return  # Skip if no user is associated with the action\n-\n     action = 'created' if created else 'updated'\n-    notify_user(action, instance, user)\n+    notify_user(action, instance)\n \n \n @receiver(post_delete)\n def delete_notification(sender, instance, **kwargs):\n@@ -32,11 +24,5 @@\n     \"\"\"\n     if not hasattr(instance, '_meta'):\n         return  # Prevent recursion errors\n \n-    model_name = instance._meta.model_name\n-    user = getattr(instance, 'deleted_by', None)  # Assuming a `deleted_by` field exists\n-\n-    if not user or not isinstance(user, CustomUser):\n-        return  # Skip if no user is associated with the action\n-\n-    notify_user('deleted', instance, user)\n+    notify_user('deleted', instance)\n"
                },
                {
                    "date": 1739872623263,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,28 +1,105 @@\n from django.db.models.signals import post_save, post_delete\n from django.dispatch import receiver\n-from .utils import notify_user\n+from django.contrib.auth.models import Permission, Group\n+from django.contrib.contenttypes.models import ContentType\n+from django.utils.timezone import now\n+from django.apps import apps\n+from accounts.models import CustomUser\n+from .models import Notification\n \n+def get_users_with_permission(model_name, app_label):\n+    \"\"\"\n+    Fetch users who have the 'view_{model_name}' permission.\n+    Includes both individual permissions and those granted via groups.\n+    \"\"\"\n+    content_type = ContentType.objects.get(app_label=app_label, model=model_name.lower())\n+    permission_codename = f'view_{model_name.lower()}'\n+    \n+    try:\n+        permission = Permission.objects.get(content_type=content_type, codename=permission_codename)\n+    except Permission.DoesNotExist:\n+        return CustomUser.objects.none()  # Return empty queryset if permission doesn't exist\n+\n+    # Get users with direct permission\n+    users = CustomUser.objects.filter(user_permissions=permission)\n+\n+    # Get users who belong to groups with the required permission\n+    users_in_groups = CustomUser.objects.filter(groups__permissions=permission)\n+\n+    # Merge both user lists and remove duplicates\n+    return users.union(users_in_groups).distinct()\n+\n+\n+def create_notification(action, instance, user):\n+    \"\"\"\n+    Create a notification only for users who have the correct permissions.\n+    Uses GenericForeignKey for better object reference.\n+    \"\"\"\n+    model_name = instance._meta.model_name\n+    app_label = instance._meta.app_label\n+\n+    users_with_permission = get_users_with_permission(model_name, app_label)\n+\n+    if not users_with_permission.exists():\n+        return  # No need to create notifications if no user has permission\n+\n+    # Identify object uniquely\n+    object_identifier = getattr(instance, 'slug', instance.pk)\n+\n+    # Define a more specific notification message\n+    action_messages = {\n+        'created': f\"{user.get_full_name()} added a new {model_name} in {app_label}.\",\n+        'updated': f\"{user.get_full_name()} updated {model_name} in {app_label}.\",\n+        'deleted': f\"{user.get_full_name()} deleted {model_name} from {app_label}.\"\n+    }\n+\n+    # Create notifications in bulk\n+    notifications = [\n+        Notification(\n+            title=f\"{model_name.capitalize()} {action.capitalize()}\",\n+            message=action_messages[action],\n+            module_name=app_label,\n+            updated_id=str(object_identifier),\n+            timestamp=now()\n+        )\n+        for user in users_with_permission\n+    ]\n+\n+    Notification.objects.bulk_create(notifications)\n+\n+\n @receiver(post_save)\n-def create_or_update_notification(sender, instance, created, **kwargs):\n+def handle_create_update_notifications(sender, instance, created, **kwargs):\n     \"\"\"\n-    Signal handler for create and update events.\n-    - Detects the model dynamically.\n-    - Ensures only the user performing the action gets notified.\n+    Handles create and update events dynamically.\n+    Uses `updated_by` field to track which user performed the action.\n     \"\"\"\n     if not hasattr(instance, '_meta'):\n-        return  # Prevent recursion errors\n+        return  # Skip non-model instances\n \n+    model_name = instance._meta.model_name\n+    user = getattr(instance, 'updated_by', None)  # Ensure models have `updated_by`\n+\n+    if not user or not isinstance(user, CustomUser):\n+        return  # Skip if no user is associated with the action\n+\n     action = 'created' if created else 'updated'\n-    notify_user(action, instance)\n+    create_notification(action, instance, user)\n \n \n @receiver(post_delete)\n-def delete_notification(sender, instance, **kwargs):\n+def handle_delete_notifications(sender, instance, **kwargs):\n     \"\"\"\n-    Signal handler for delete events.\n-    - Ensures only users with permission get notified.\n+    Handles delete events dynamically.\n+    Uses `deleted_by` field to track the user who performed the delete action.\n     \"\"\"\n     if not hasattr(instance, '_meta'):\n-        return  # Prevent recursion errors\n+        return  # Skip non-model instances\n \n-    notify_user('deleted', instance)\n+    model_name = instance._meta.model_name\n+    user = getattr(instance, 'deleted_by', None)  # Ensure models have `deleted_by`\n+\n+    if not user or not isinstance(user, CustomUser):\n+        return  # Skip if no user is associated with the action\n+\n+    create_notification('deleted', instance, user)\n"
                }
            ],
            "date": 1739869421688,
            "name": "Commit-0",
            "content": "from django.db.models.signals import post_save, post_delete\nfrom django.dispatch import receiver\nfrom django.contrib.auth import get_user_model\nfrom .models import Notification\nfrom .utils import create_notification\n\nUser = get_user_model()\n\n@receiver(post_save, sender=User)\ndef notify_on_user_update(sender, instance, created, **kwargs):\n    \"\"\"\n    Notify users when they register or update their account.\n    \"\"\"\n    action = \"created\" if created else \"updated\"\n    create_notification(\n        instance,\n        action,\n        sender.__name__.lower(),\n        instance.id,\n        f\"Your account has been {action}.\"\n    )\n\n@receiver(post_delete, sender=User)\ndef notify_on_user_delete(sender, instance, **kwargs):\n    \"\"\"\n    Notify users when their account is deleted.\n    \"\"\"\n    create_notification(\n        instance,\n        \"deleted\",\n        sender.__name__.lower(),\n        instance.id,\n        \"Your account has been deleted.\"\n    )\n"
        }
    ]
}